@using WebTIGA;
@using System.Globalization;

@model WebTIGA.Models.ContenedorModelos
@{
    ViewBag.Title = "Inicio";
    ViewBag.MensajeLoad = "Visible";
    Layout = "~/Views/Shared/_Layout_CuentasSig.cshtml";
    var sel = "selected";
    int? anio = DateTime.Today.Year;

}

<div class="row">
    <div class="col-lg-12">
        <div class="card text-white bg-secondary mb-3">
            <div class="card-header"><strong>INICIO</strong></div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-5">
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 font-weight-bold text-dark">Carga de Información</h6>
            </div>

            <div class="card-body">
                @using (Html.BeginForm("UploadFile", "CuentasSignificativas", FormMethod.Post, new { enctype = "multipart/form-data" }))
                {
                    <a>Año: </a>
                    <select @Html.TextBox("Anio", null, new { style = "text-transform:uppercase", @class = "form-control", placeholder = "Anio" })>
                        @for (int i = 2017; i <= DateTime.Today.Year; i++)
                        {
                            <option @(i == anio ? "selected" : "")>@i</option>
                        }
                    </select>
                    <br />
                    <a>Mes: </a>
                    <select @Html.TextBox("Mes", null, new { style = "text-transform:uppercase", @class = "form-control", placeholder = "Mes" })>
                        @for (int i = 1; i <= 12; i++)
                        {
                            <option>@i</option>
                        }
                    </select>
                    <br />
                    <div>
                        <div class="d-flex justify-content-center mb-4">
                            @Html.TextBox("file", "", new { type = "file" }) <br />
                            @ViewBag.Message
                        </div>
                        <div class="d-flex justify-content-center">
                            <button id="btn-subir" onclick="progressAlert()" type="submit" class="btn btn-info" style="background-color :lightseagreen">
                                <i class="fas fa-upload"></i> Subir archivo
                            </button>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>


    <div class="col-lg-7">
        <div class="card shadow">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 font-weight-bold text-dark">Administración de Informes</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table id="tabla-periodos" class="table table-hover" width="100%" style="font-size: 0.9rem;">
                        <thead class="table-active">
                            <tr>
                                <th class="text-center" style="width: 27%">Año</th>
                                <th class="text-center" style="width: 27%">Mes</th>
                                <th class="text-center" style="width: 28%">Fecha de Carga</th>
                                <th class="text-center" style="width: 18%"></th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model.VIEW_BC_HOJAS_CARGADAS)
                            {
                            <tr>
                                <td class="text-center">@item.AÑO</td>
                                <td class="text-center">@CultureInfo.CurrentCulture.DateTimeFormat.GetMonthName(Int32.Parse(item.PERIODO.ToString().Substring(4, 2)))</td>
                                <td class="text-center">@item.FECHA_CARGA</td>
                                <td class="text-center">
                                    <div class="btn-group">

                                        <a class="pr-3" href="@Url.Action("DescargarHojaTrabajo", "CuentasSignificativas", new { periodo = item.PERIODO})">
                                            <i class="fas fa-download text-success"></i>
                                        </a>

                                        @using (Html.BeginForm("DeleteFile", "CuentasSignificativas", FormMethod.Post))
                                        {
                                            @Html.AntiForgeryToken()
                                            <input id="periodo" name="periodo" type="text" value="@item.PERIODO" hidden />
                                            <button class="btn-icon" onclick="progressAlert()" type="submit" title="Eliminar">
                                                <i class="fas fa-trash-alt text-danger"></i>
                                            </button>
                                        }
                                    </div>
                                </td>
                            </tr>
                            }
                        </tbody>
                    </table>
                </div>

            </div>
        </div>
    </div>
</div>

<script type="text/javascript" class="init">

    $(document).ready(function () {
        $('#tabla-periodos').DataTable({
            "dom": "<'row pb-2'<'col-sm-12 col-md-6'l><'col-sm-12 col-md-6'f>>" +
                "<'row'<'col-sm-12'tr>>" +
                "<'row'<'col-sm-12 col-md-5'i><'col-sm-12 col-md-7'p>>",
            "ordering": false,
            "searching": true,
            "paging": true,
            "scrollY": "50vh",
            "language": {
                "lengthMenu": "Mostrar _MENU_ registros",
                "zeroRecords": "No hay datos disponibles para los filtros seleccionados",
                "info": "Mostrandose _TOTAL_ registros",
                "infoEmpty": "No hay registros disponibles",
                "infoFiltered": "(filtrado de _MAX_ registros)",
                "search": "Buscar:"
            }
        });

        if ('@ViewBag.Alerta' == "confirm") {
            Swal.fire({
                title: 'Carga Completa',
                text: 'Se ha realizado la carga de la información de forma correcta',
                icon: 'success',
                confirmButtonColor: 'lightseagreen'
            });
        }
        else if ('@ViewBag.Alerta' == "error") {
            Swal.fire({
                title: 'Error en la Carga',
                text: 'Revisar la fuente de información',
                icon: 'error',
                confirmButtonColor: 'lightseagreen'
            });
        }
        else if ('@ViewBag.Alerta' == "deleted") {
            Swal.fire({
                title: 'Datos Eliminados',
                text: 'Se han eliminado los registros de la base de datos.',
                icon: 'success',
                confirmButtonColor: 'lightseagreen'
            });
        }
        else if ('@ViewBag.Alerta' == "delete-error") {
            Swal.fire({
                title: 'Error',
                text: 'Hubo un problema al realizar la operación, inténtelo nuevamente',
                icon: 'error',
                confirmButtonColor: 'lightseagreen'
            });
        }
    });    

    function progressAlert() {
        Swal.fire({
            title: 'Por favor, espere',
            text: 'Procesando la información ...',
            allowOutsideClick: false,
            showConfirmButton: false,
            willOpen: () => {
                Swal.showLoading()
            },
        });
    }

</script>
